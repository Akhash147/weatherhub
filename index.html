<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WeatherHub - Check current weather and 5-day forecast for any city. Features geolocation, dark mode, and a helpful chatbot.">
    <meta name="keywords" content="weather, forecast, current weather, geolocation, dark mode, chatbot">
    <meta name="author" content="Akhash">
    <meta property="og:title" content="WeatherHub - Your Weather Companion">
    <meta property="og:description" content="Get current weather and 5-day forecasts for any city with WeatherHub. Features geolocation, dark mode, and a chatbot.">
    <meta property="og:image" content="https://akhash147.github.io/weatherhub/background.jpg">
    <meta property="og:url" content="https://akhash147.github.io/weatherhub">
    <meta property="og:type" content="website">
    <title>WeatherHub</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode" tabindex="0">
        <span class="dark-mode-icon">🌙</span>
    </button>

    <div class="container">
        <h1>WeatherHub</h1>
        <div class="search-box">
            <div class="autocomplete-wrapper">
                <input type="text" id="cityInput" placeholder="Enter city name" tabindex="0" oninput="debouncedShowSuggestions()" autocomplete="off">
                <div class="suggestions" id="suggestions"></div>
            </div>
            <button onclick="getWeather()" tabindex="0">Get Weather</button>
            <button onclick="getWeatherByLocation()" class="geo-button" title="Get weather for your location" tabindex="0">
                <span>📍</span> Use My Location
            </button>
        </div>
        <div class="error" id="error"></div>
        <div class="loading" id="loading">Loading...</div>
        <div class="weather-alert" id="weatherAlert"></div>
        <div class="weather-info" id="weatherInfo">
            <div class="weather-header">
                <h2 id="cityName"></h2>
                <img id="weatherIcon" src="" alt="Weather Icon">
            </div>
            <div class="weather-details">
                <p id="temperature"><span class="icon">🌡️</span></p>
                <p id="description"></p>
                <p id="humidity"><span class="icon">💧</span></p>
                <p id="wind"><span class="icon">💨</span></p>
            </div>
            <div class="forecast" id="forecast">
                <h3>5-Day Forecast</h3>
                <div class="forecast-container" id="forecastContainer"></div>
            </div>
            <div class="chart-container">
                <h3>Temperature Trend (5 Days)</h3>
                <canvas id="tempChart"></canvas>
            </div>
        </div>
    </div>

    <div class="chatbot-container">
        <div class="chatbot-toggle" onclick="toggleChatbot()" tabindex="0">
            <span>💬</span> Chat Support
        </div>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>WeatherBot</h3>
                <button onclick="toggleChatbot()" tabindex="0">✖</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="message bot-message">Hello! I'm WeatherBot. How can I help you today? Type "help" for assistance.</div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Type your message..." onkeypress="if(event.key === 'Enter') sendMessage()" tabindex="0">
                <button onclick="sendMessage()" tabindex="0">Send</button>
            </div>
        </div>
    </div>

    <footer>
        Weather data provided by <a href="https://openweathermap.org" target="_blank">OpenWeatherMap</a> | Built by <a href="https://github.com/Akhash147" target="_blank">Akhash</a>
    </footer>

    <script>
        let tempChart = null;
        let cities = [];

        // Fallback list of cities (in case the dataset fails to load)
        const fallbackCities = [
            "London", "Paris", "New York", "Tokyo", "Mumbai", "Sydney",
            "Toronto", "Berlin", "Rome", "Moscow", "Dubai", "Singapore",
            "Los Angeles", "Chicago", "Miami", "Bangkok", "Seoul", "Beijing",
            "Cape Town", "Rio de Janeiro", "Amsterdam", "Vienna", "Stockholm",
            "Delhi", "Kolkata", "Chennai", "Bangalore", "Hyderabad",
            "San Francisco", "Boston", "Seattle", "Washington", "Houston",
            "Vancouver", "Montreal", "Mexico City", "Sao Paulo", "Buenos Aires",
            "Lima", "Bogota", "Santiago", "Caracas", "Quito",
            "Madrid", "Barcelona", "Lisbon", "Dublin", "Oslo",
            "Helsinki", "Copenhagen", "Prague", "Budapest", "Warsaw",
            "Athens", "Istanbul", "Kyiv", "Bucharest", "Belgrade",
            "Shanghai", "Hong Kong", "Jakarta", "Manila", "Kuala Lumpur",
            "Ho Chi Minh City", "Hanoi", "Taipei", "Dhaka", "Karachi",
            "Lahore", "Islamabad", "Colombo", "Kathmandu", "Yangon",
            "Cairo", "Lagos", "Nairobi", "Johannesburg", "Accra",
            "Algiers", "Casablanca", "Tunis", "Addis Ababa", "Dar es Salaam",
            "Sydney", "Melbourne", "Brisbane", "Perth", "Auckland",
            "Wellington", "Christchurch", "Honolulu", "Suva", "Port Moresby",
            "Riyadh", "Jeddah", "Doha", "Kuwait City", "Abu Dhabi",
            "Amman", "Beirut", "Tehran", "Baghdad", "Ankara"
        ];

        // Load cities from localStorage or fetch from CDN
        async function loadCities() {
            const storedCities = localStorage.getItem('cityList');
            if (storedCities) {
                cities = JSON.parse(storedCities);
                return;
            }

            try {
                // Using a CDN-hosted world-cities dataset (~40,000 cities)
                const response = await fetch('https://raw.githubusercontent.com/lutangar/cities.json/master/cities.json');
                if (!response.ok) throw new Error('Failed to fetch city list.');
                
                const data = await response.json();
                // Extract city names (data is an array of objects with 'name' and 'country' fields)
                cities = data.map(city => city.name).filter(name => name); // Remove any undefined/null names
                cities = [...new Set(cities)]; // Remove duplicates
                cities.sort(); // Sort alphabetically

                // Store in localStorage for future use
                localStorage.setItem('cityList', JSON.stringify(cities));
            } catch (error) {
                console.error('Error loading cities:', error);
                cities = fallbackCities; // Use fallback list if fetch fails
            }
        }

        // Debounce function to limit how often showSuggestions is called
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Show suggestions with a limit of 10 matches
        function showSuggestions() {
            const input = document.getElementById('cityInput').value.trim().toLowerCase();
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.innerHTML = '';

            if (!input) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            // Filter cities (case-insensitive, starts with input)
            const filteredCities = cities.filter(city => city.toLowerCase().startsWith(input));
            const limitedCities = filteredCities.slice(0, 10); // Limit to 10 suggestions

            if (limitedCities.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            limitedCities.forEach(city => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('suggestion-item');
                suggestionItem.textContent = city;
                suggestionItem.onclick = () => {
                    document.getElementById('cityInput').value = city;
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.style.display = 'none';
                    getWeather();
                };
                suggestionsContainer.appendChild(suggestionItem);
            });

            suggestionsContainer.style.display = 'block';
        }

        // Debounced version of showSuggestions
        const debouncedShowSuggestions = debounce(showSuggestions, 300);

        document.addEventListener('click', (e) => {
            const suggestionsContainer = document.getElementById('suggestions');
            const cityInput = document.getElementById('cityInput');
            if (!cityInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        // Load cities when the page loads
        window.onload = async () => {
            await loadCities();
            // Load dark mode preference after cities are loaded
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-icon').textContent = '☀️';
            }
        };

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.querySelector('.dark-mode-icon').textContent = isDarkMode ? '☀️' : '🌙';
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateChartTheme();
        }

        async function getWeather(city = null, lat = null, lon = null) {
            const cityInput = city || document.getElementById('cityInput').value.trim();
            const apiKey = 'bd5e378503939ddaee76f12ad7a97608';
            let url = lat && lon 
                ? `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
                : `https://api.openweathermap.org/data/2.5/weather?q=${cityInput}&appid=${apiKey}&units=metric`;

            const errorElement = document.getElementById('error');
            const weatherInfoElement = document.getElementById('weatherInfo');
            const loadingElement = document.getElementById('loading');
            const alertElement = document.getElementById('weatherAlert');

            errorElement.classList.remove('show');
            weatherInfoElement.classList.remove('show');
            alertElement.classList.remove('show');
            loadingElement.classList.add('show');

            if (!cityInput && !lat && !lon) {
                errorElement.textContent = 'Please enter a city name or allow location access.';
                errorElement.classList.add('show');
                loadingElement.classList.remove('show');
                return null;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401) throw new Error('Invalid API key.');
                    if (response.status === 404) throw new Error('City not found.');
                    if (response.status === 429) throw new Error('API rate limit exceeded.');
                    throw new Error(`API error: ${errorData.message || 'Unknown error'}`);
                }

                const data = await response.json();
                document.getElementById('cityName').textContent = `${data.name}, ${data.sys.country}`;
                document.getElementById('weatherIcon').src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
                document.getElementById('temperature').innerHTML = `<span class="icon">🌡️</span> Temperature: ${data.main.temp}°C`;
                document.getElementById('description').textContent = `Weather: ${data.weather[0].description}`;
                document.getElementById('humidity').innerHTML = `<span class="icon">💧</span> Humidity: ${data.main.humidity}%`;
                document.getElementById('wind').innerHTML = `<span class="icon">💨</span> Wind Speed: ${data.wind.speed} m/s`;

                let alertMessage = '';
                if (data.main.temp > 40) alertMessage = '⚠️ Extreme Heat Warning: Temperature exceeds 40°C!';
                else if (data.main.temp < 0) alertMessage = '⚠️ Freezing Warning: Temperature below 0°C!';
                else if (data.wind.speed > 15) alertMessage = '⚠️ High Wind Warning: Wind speed exceeds 15 m/s!';
                if (alertMessage) {
                    alertElement.textContent = alertMessage;
                    alertElement.classList.add('show');
                }

                weatherInfoElement.classList.add('show');
                loadingElement.classList.remove('show');

                await getForecast(data.name);
                return data;
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.classList.add('show');
                loadingElement.classList.remove('show');
                document.getElementById('cityInput').value = '';
                return null;
            }
        }

        async function getForecast(city) {
            const apiKey = 'bd5e378503939ddaee76f12ad7a97608';
            const url = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`;
            const forecastContainer = document.getElementById('forecastContainer');
            forecastContainer.innerHTML = '';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Unable to fetch forecast.');

                const data = await response.json();
                const dailyData = [];
                const temperatures = [];
                const dates = [];

                for (let i = 0; i < data.list.length; i += 8) {
                    const entry = data.list[i];
                    const date = new Date(entry.dt * 1000).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    dailyData.push({
                        date: date,
                        temp: entry.main.temp,
                        icon: entry.weather[0].icon,
                        description: entry.weather[0].description
                    });
                    temperatures.push(entry.main.temp);
                    dates.push(date);
                }

                dailyData.forEach(day => {
                    const forecastCard = document.createElement('div');
                    forecastCard.classList.add('forecast-card');
                    forecastCard.innerHTML = `
                        <h4>${day.date}</h4>
                        <img src="https://openweathermap.org/img/wn/${day.icon}.png" alt="Weather Icon">
                        <p>${day.temp}°C</p>
                        <p>${day.description}</p>
                    `;
                    forecastContainer.appendChild(forecastCard);
                });

                updateTemperatureChart(dates, temperatures);
            } catch (error) {
                console.error('Error fetching forecast:', error);
            }
        }

        function updateTemperatureChart(dates, temperatures) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const isDarkMode = document.body.classList.contains('dark-mode');

            if (tempChart) tempChart.destroy();

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: temperatures,
                        borderColor: isDarkMode ? '#b565d9' : '#4a90e2',
                        backgroundColor: isDarkMode ? 'rgba(181, 101, 217, 0.2)' : 'rgba(74, 144, 226, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (°C)',
                                color: isDarkMode ? '#ddd' : '#333'
                            },
                            ticks: {
                                color: isDarkMode ? '#ddd' : '#333'
                            },
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: isDarkMode ? '#ddd' : '#333'
                            },
                            ticks: {
                                color: isDarkMode ? '#ddd' : '#333'
                            },
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#ddd' : '#333'
                            }
                        }
                    }
                }
            });
        }

        function updateChartTheme() {
            const weatherInfoElement = document.getElementById('weatherInfo');
            if (weatherInfoElement.classList.contains('show')) {
                const city = document.getElementById('cityName').textContent.split(',')[0];
                getForecast(city);
            }
        }

        function getWeatherByLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        getWeather(null, lat, lon);
                    },
                    (error) => {
                        const errorElement = document.getElementById('error');
                        errorElement.textContent = 'Unable to access location. Please enter a city name.';
                        errorElement.classList.add('show');
                        document.getElementById('loading').classList.remove('show');
                    }
                );
            } else {
                const errorElement = document.getElementById('error');
                errorElement.textContent = 'Geolocation is not supported by your browser.';
                errorElement.classList.add('show');
                document.getElementById('loading').classList.remove('show');
            }
        }

        document.getElementById('cityInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                getWeather();
            }
        });

        function toggleChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotWindow.classList.toggle('show');
        }

        function addMessage(content, isBot = false) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isBot ? 'bot-message' : 'user-message');
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const userMessage = input.value.trim().toLowerCase();
            if (!userMessage) return;

            addMessage(userMessage, false);
            input.value = '';

            if (userMessage.includes('how do i use') || userMessage.includes('help')) {
                addMessage('To use WeatherHub, start typing a city name in the search bar to see suggestions, then click "Get Weather" or press Enter. You can also click "Use My Location" to get weather for your current location. The app shows current weather, a 5-day forecast, and a temperature trend chart. Toggle dark mode with the button in the top-right corner.', true);
            } else if (userMessage.includes('what data') || userMessage.includes('what information')) {
                addMessage('The app displays the city name, country, temperature (°C), weather description, humidity (%), wind speed (m/s), a 5-day forecast, and a temperature trend chart. You’ll also see alerts for extreme weather conditions.', true);
            } else if (userMessage.includes('weather in')) {
                const cityMatch = userMessage.match(/weather in ([\w\s]+)/);
                if (cityMatch && cityMatch[1]) {
                    const city = cityMatch[1].trim();
                    addMessage(`Fetching weather for ${city}...`, true);
                    const weatherData = await getWeather(city);
                    if (weatherData) {
                        addMessage(`The weather in ${weatherData.name}, ${weatherData.sys.country} is ${weatherData.weather[0].description} with a temperature of ${weatherData.main.temp}°C, humidity at ${weatherData.main.humidity}%, and wind speed of ${weatherData.wind.speed} m/s.`, true);
                    } else {
                        const suggestions = suggestCities(city);
                        addMessage(`Sorry, I couldn’t find ${city}. Did you mean one of these? ${suggestions.join(', ')}`, true);
                    }
                } else {
                    addMessage('Please specify a city (e.g., "weather in London").', true);
                }
            } else if (userMessage.includes('hi') || userMessage.includes('hello')) {
                addMessage('Hello! I’m WeatherBot. I can help you use WeatherHub or fetch weather data for a city. What would you like to do?', true);
            } else if (userMessage.includes('temperature unit')) {
                addMessage('The temperature is displayed in Celsius (°C).', true);
            } else if (userMessage.includes('forecast')) {
                addMessage('After searching for a city, you’ll see a 5-day forecast below the current weather. It includes the date, temperature, and weather conditions for each day.', true);
            } else if (userMessage.includes('dark mode')) {
                addMessage('You can toggle dark mode using the button in the top-right corner (🌙 or ☀️). Your preference is saved automatically.', true);
            } else if (userMessage.includes('my location')) {
                addMessage('Click the "Use My Location" button (📍) to get the weather for your current location. Make sure to allow location access when prompted.', true);
            } else {
                addMessage('I’m not sure how to help with that. Try asking "how do I use this?", "weather in London", or "what data is shown?".', true);
            }
        }

        function suggestCities(city) {
            const cityMap = {
                'lndon': 'London',
                'paris': 'Paris',
                'new yrok': 'New York',
                'tokoyo': 'Tokyo',
                'mumbay': 'Mumbai',
                'sidney': 'Sydney'
            };
            const suggestions = [];
            const cityLower = city.toLowerCase();
            for (const key in cityMap) {
                if (key.includes(cityLower) || cityLower.includes(key)) {
                    suggestions.push(cityMap[key]);
                }
            }
            return suggestions.length ? suggestions : ['London', 'Paris', 'New York'];
        }
    </script>
</body>
</html>